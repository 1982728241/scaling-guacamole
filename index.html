<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI NPC æ™ºèƒ½å¯¹è¯ç‰ˆï¼ˆæ— é‡å¤/æ— undefinedï¼‰</title>
    <style>
        * {margin:0;padding:0;box-sizing: border-box;font-family: "å¾®è½¯é›…é»‘", sans-serif;}
        body {background: #1d2939;padding: 20px;color:#fff;}
        .game-box {width: 1000px;margin:0 auto;border: 2px solid #6b7280;border-radius: 8px;background: #111827;padding:15px;}
        .npc-select {margin-bottom:15px;padding:10px;background:#27272a;border-radius:6px;}
        .npc-select button {padding:8px 15px;margin:0 5px;border:none;border-radius:4px;background:#3b82f6;color:#fff;cursor:pointer;}
        .npc-select button:hover {background:#2563eb;}
        .npc-info {padding:10px;background:#0f172a;border-radius:6px;margin-bottom:15px;line-height:1.8;}
        .dialog-box {width:100%;height:350px;border:1px solid #6b7280;border-radius:6px;padding:10px;background:#030712;overflow-y:auto;margin-bottom:15px;}
        .dialog-item {margin-bottom:10px;padding:8px;border-radius:6px;max-width:90%;}
        .player-dialog {background:#3b82f6;margin-left:auto;text-align:right;}
        .npc-dialog {background:#4b5563;margin-right:auto;text-align:left;}
        .api-tip {padding:10px;background:#f59e0b;border-radius:6px;margin-bottom:15px;color:#111;}
        .input-box {display:flex;gap:10px;margin-bottom:15px;}
        #playerInput {flex:1;padding:10px;border:1px solid #6b7280;border-radius:6px;background:#1f2937;color:#fff;font-size:16px;outline:none;}
        #sendBtn {padding:0 20px;border:none;border-radius:6px;background:#10b981;color:#fff;cursor:pointer;font-size:16px;}
        #sendBtn:hover {background:#059669;}
        .func-panel {display:flex;gap:10px;margin-bottom:15px;}
        .func-panel button {flex:1;padding:12px;border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:16px;}
        #collectBtn {background:#84cc16;}
        #mineBtn {background:#b45309;}
        #fightBtn {background:#ef4444;}
        .status-panel {display:flex;gap:15px;padding:10px;background:#27272a;border-radius:6px;}
        .status-item {flex:1;line-height:1.8;}
        b {color:#fbbf24;}
    </style>
</head>
<body>
    <div class="game-box">
        <div class="api-tip">
            ğŸ“Œ æ™ºèƒ½å¯¹è¯ç‰ˆ | æ— é‡å¤è¯æœ¯ | æ— undefined | æ”¯æŒè‡ªç”±æé—®
        </div>
        <div class="input-box" style="margin-bottom:15px;">
            <input type="text" id="apiKeyInput" placeholder="è¯·è¾“å…¥ä½ çš„ç«å±±æ–¹èˆŸAPI-KEYï¼ˆå…è´¹è·å–ï¼‰" style="flex:1;">
        </div>
        <div class="npc-select">
            <button onclick="changeNPC('liya')">âœ… ç»¿æ´²ä¹‹åŸ - è‰å¨…(é‡‡é›†/ç‚¼é‡‘Â·æ¸©æŸ”)</button>
            <button onclick="changeNPC('senen')">â›ï¸ ç»¿å¶ç²¾çµåŸ - æ£®æ©(æŒ–çŸ¿/é”»é€ Â·ç²—çŠ·)</button>
            <button onclick="changeNPC('huoke')">âš”ï¸ è¾¹å¢ƒå°é•‡ - éœå…‹(æˆ˜æ–—/ç‹©çŒÂ·æ²‰ç¨³)</button>
        </div>
        <div class="npc-info" id="npcInfo">
            <b>å½“å‰NPCï¼š</b>ç»¿æ´²ä¹‹åŸ - è‰å¨…<br>
            <b>æ€§æ ¼ï¼š</b>æ´»æ³¼æ¸©æŸ” | <b>æ“…é•¿ï¼š</b>é‡‡é›†ã€ç‚¼é‡‘ | <b>å£å¤´ç¦…ï¼š</b>å‘€ï¼Œè¿™ä¸ªè¯è‰è¶…ç¨€æœ‰å‘¢ï¼
        </div>
        <div class="dialog-box" id="dialogBox">
            <div class="dialog-item npc-dialog">ä½ å¥½å‘€ï½æˆ‘æ˜¯è‰å¨…ï¼Œæœ‰ä»€ä¹ˆæƒ³é—®æˆ‘çš„éƒ½å¯ä»¥è¯´å“¦ï¼Œæ¯”å¦‚ã€Œå“ªé‡Œé‡‡é›†ç¨€æœ‰è¯è‰ï¼Ÿã€ã€Œç‚¼é‡‘éœ€è¦ä»€ä¹ˆææ–™ï¼Ÿã€âœ¨</div>
        </div>
        <div class="input-box">
            <input type="text" id="playerInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ æƒ³å¯¹NPCè¯´çš„è¯ï¼Œæ¯”å¦‚ï¼šå“ªé‡Œé‡‡é›†è¯è‰ï¼Ÿã€æŒ–çŸ¿èƒ½å‡ºä»€ä¹ˆçŸ¿çŸ³ï¼Ÿã€å“¥å¸ƒæ—æ€ä¹ˆæ‰“ï¼Ÿ">
            <button id="sendBtn" onclick="sendMsg()">å‘é€å¯¹è¯</button>
        </div>
        <div class="func-panel">
            <button id="collectBtn" onclick="doCollect()">ğŸŒ¿ é‡‡é›†è¯è‰</button>
            <button id="mineBtn" onclick="doMine()">â›°ï¸ æŒ–æ˜çŸ¿çŸ³</button>
            <button id="fightBtn" onclick="doFight()">âš”ï¸ æˆ˜æ–—æ‰“æ€ª</button>
        </div>
        <div class="status-panel">
            <div class="status-item">
                <b>å½“å‰BUFFçŠ¶æ€ï¼š</b><span id="buffStatus">æ— BUFF</span><br>
                <b>BUFFå‰©ä½™æ—¶é—´ï¼š</b><span id="buffTime">0 ç§’</span>
            </div>
            <div class="status-item">
                <b>ç»¿æ´²å£°æœ›ï¼š</b><span id="shengwangLiya">0</span><br>
                <b>ç»¿å¶å£°æœ›ï¼š</b><span id="shengwangSenen">0</span><br>
                <b>è¾¹å¢ƒå£°æœ›ï¼š</b><span id="shengwangHuoke">0</span>
            </div>
            <div class="status-item">
                <b>è¯è‰æ•°é‡ï¼š</b><span id="herbNum">0</span><br>
                <b>çŸ¿çŸ³æ•°é‡ï¼š</b><span id="oreNum">0</span><br>
                <b>è§’è‰²ç»éªŒï¼š</b><span id="expNum">0</span>
            </div>
        </div>
    </div>

    <script>
        let playerData = {herb:0,ore:0,exp:0,shengwang:{liya:0,senen:0,huoke:0},buff:{name:"",active:false,time:0,effect:""},memory:[],memoryMax:5};
        // âœ… ä¼˜åŒ–NPCé…ç½®ï¼šå¢åŠ ã€Œæ™ºèƒ½å…œåº•å›å¤åº“ã€ï¼Œé¿å…é‡å¤
        const NPC_CONFIG = {
            liya:{
                name:"ç»¿æ´²ä¹‹åŸ - è‰å¨…",
                personality:"æ´»æ³¼æ¸©æŸ”ã€çƒ­å¿ƒè‚ ",
                specialty:"é‡‡é›†å„ç§è¯è‰ã€åˆ¶ä½œç–—ä¼¤è¯æ°´ã€è¾¨è¯†ç¨€æœ‰è‰è¯",
                mantra:"å‘€ï¼Œè¿™ä¸ªè¯è‰è¶…ç¨€æœ‰å‘¢ï¼",
                buff:{name:"é‡‡é›†å¹¸è¿",effect:"ç¨€æœ‰è¯è‰æ¦‚ç‡+30%ï¼Œé‡‡é›†ç»éªŒç¿»å€",duration:120},
                buffKeys:["é‡‡é›†","è¯è‰","ç‚¼é‡‘","è‰è¯","è¯æ°´"],
                // âœ… è‰å¨…çš„æ™ºèƒ½å…œåº•å›å¤åº“ï¼ˆæ ¹æ®ç©å®¶æé—®æ–¹å‘åŒ¹é…ï¼‰
                replies: [
                    "åŸå¤–çš„æ™¨æ›¦æ£®æ—é‡Œè¯è‰æœ€å¤šå•¦ï¼Œå°¤å…¶æ˜¯å°æºªè¾¹çš„è–„è·è‰ï¼Œè¶…å¥½ç”¨ï½",
                    "é‡‡é›†ç¨€æœ‰è¯è‰è¦åœ¨æ¸…æ™¨å»å“¦ï¼Œé‚£æ—¶çš„éœ²æ°´èƒ½è®©è¯è‰å“è´¨æ›´å¥½ï½",
                    "ç‚¼é‡‘éœ€è¦å…ˆæ”¶é›†3æ ªè–„è·è‰+1ä¸ªéœ²æ°´ï¼Œæˆ‘å¯ä»¥æ•™ä½ åšåˆçº§ç–—ä¼¤è¯æ°´ï½",
                    "å°å¿ƒæ£®æ—é‡Œçš„å°æ¾é¼ ï¼Œå®ƒä»¬ä¼šå·è¯è‰å“¦ï¼Œå¸¦ç‚¹åšæœå°±èƒ½èµ¶èµ°å®ƒä»¬å•¦ï½",
                    "ä½ çš„é‡‡è¯ç­‰çº§å¤Ÿé«˜çš„è¯ï¼Œèƒ½æŒ–åˆ°ç™¾å¹´äººå‚ï¼Œå–ç»™å•†ä¼šèƒ½èµšå¥½å¤šé‡‘å¸å‘¢ï½"
                ]
            },
            senen:{
                name:"ç»¿å¶ç²¾çµåŸ - æ£®æ©",
                personality:"ç²—çŠ·ç›´çˆ½ã€è®²ä¹‰æ°”",
                specialty:"æŒ–æ˜å„ç§çŸ¿çŸ³ã€é”»é€ æ­¦å™¨è£…å¤‡ã€è¾¨è¯†çŸ¿è„‰ä½ç½®",
                mantra:"å¥½çŸ¿ï¼é”»å‡ºæ¥çš„è£…å¤‡è‚¯å®šé¡¶ï¼",
                buff:{name:"æŒ–çŸ¿æš´å‡»",effect:"çŸ¿çŸ³æ•°é‡Ã—2ï¼ŒæŒ–çŸ¿ç»éªŒç¿»å€",duration:120},
                buffKeys:["æŒ–çŸ¿","çŸ¿çŸ³","é”»é€ ","çŸ¿æ´","è£…å¤‡"],
                // âœ… æ£®æ©çš„æ™ºèƒ½å…œåº•å›å¤åº“
                replies: [
                    "è¥¿è¾¹çš„é»‘çŸ³å±±çŸ¿æ´çŸ¿çŸ³æœ€çº¯ï¼Œé“çŸ¿ã€é“œçŸ¿éƒ½æœ‰ï¼Œå°±æ˜¯è¦å°å¿ƒè½çŸ³ï½",
                    "æŒ–çŸ¿è®°å¾—å¸¦é•å­ï¼Œç ´æŸçš„é•å­æŒ–ä¸å‡ºå¥½çŸ¿ï¼Œæˆ‘è¿™æœ‰å¤‡ç”¨çš„ï½",
                    "é”»é€ é“å‰‘éœ€è¦5å—é“çŸ¿+2å—æœ¨ç‚­ï¼Œé”»å‡ºæ¥çš„å‰‘ç å“¥å¸ƒæ—è¶…é¡ºæ‰‹ï½",
                    "æ·±å±‚çŸ¿æ´æœ‰ç§˜é“¶çŸ¿ï¼Œä½†æ˜¯æœ‰çŸ¿é¼ æ€ªå®ˆç€ï¼Œç­‰çº§å¤Ÿäº†å†å»ï¼",
                    "çŸ¿çŸ³è¦è¶çƒ­é”»é€ ï¼Œä¸ç„¶ä¼šè„†ï¼Œæˆ‘æ•™ä½ æ€ä¹ˆæ§åˆ¶ç«å€™ï½"
                ]
            },
            huoke:{
                name:"è¾¹å¢ƒå°é•‡ - éœå…‹",
                personality:"æ²‰é»˜å¯¡è¨€ã€æ²‰ç¨³å¯é ã€æˆ˜æ–—ç»éªŒä¸°å¯Œ",
                specialty:"ç‹©çŒæ€ªç‰©ã€ä¼ æˆæˆ˜æ–—æŠ€å·§ã€è¾¨è¯†æ€ªç‰©å¼±ç‚¹",
                mantra:"è®°ä½ï¼Œæ€ªç‰©çš„å¼±ç‚¹æ°¸è¿œåœ¨ç ´ç»½å¤„ã€‚",
                buff:{name:"å¼±ç‚¹ç¿»å€",effect:"æ€ªç‰©å¼±ç‚¹ä¼¤å®³Ã—2ï¼Œæˆ˜æ–—ç»éªŒç¿»å€",duration:120},
                buffKeys:["æˆ˜æ–—","æ‰“æ€ª","å“¥å¸ƒæ—","å²è±å§†","å¼±ç‚¹","ç‹©çŒ"],
                // âœ… éœå…‹çš„æ™ºèƒ½å…œåº•å›å¤åº“
                replies: [
                    "å“¥å¸ƒæ—çš„å¼±ç‚¹åœ¨è†ç›–ï¼Œæ”»å‡»é‚£é‡Œèƒ½è®©å®ƒç›´æ¥å€’åœ°ï½",
                    "å²è±å§†æ€•ç«ï¼Œå¸¦ä¸ªç«æŠŠå°±èƒ½è½»æ¾å¯¹ä»˜ï¼Œåˆ«ç”¨å‰‘ç ï¼Œä¼šé»ä½ï½",
                    "ç‹©çŒå…½äººè¦ç»„é˜Ÿï¼Œå®ƒä»¬çš„æ–§å¤´ç äººè¶…ç–¼ï¼Œå…ˆèº²å†åå‡»ï½",
                    "ä½ çš„æˆ˜æ–—ç­‰çº§æå‡åï¼Œèƒ½æŒ‘æˆ˜ç‹¼ç‹ï¼Œæ‰è½çš„ç‹¼ç‰™èƒ½åšæŠ¤èº«ç¬¦ï½",
                    "æˆ˜æ–—å‰è®°å¾—æ£€æŸ¥è£…å¤‡ï¼Œç ´æŸçš„é“ ç”²å¯æŒ¡ä¸ä½æ€ªç‰©çš„æ”»å‡»ï½"
                ]
            }
        };
        let currentNPC = "liya";let buffTimer = null;
        // âœ… ç«å±±æ–¹èˆŸæœ€æ–°æœ‰æ•ˆæ¥å£åœ°å€
        const API_URL = "https://ark.cn-beijing.volces.com/api/v3/chat/completions";

        // âœ… é€šç”¨çŠ¶æ€æ›´æ–°å‡½æ•°ï¼ˆä¸å˜ï¼‰
        function updateStatus(){
            document.getElementById("herbNum").innerText=playerData.herb;
            document.getElementById("oreNum").innerText=playerData.ore;
            document.getElementById("expNum").innerText=playerData.exp;
            document.getElementById("shengwangLiya").innerText=playerData.shengwang.liya;
            document.getElementById("shengwangSenen").innerText=playerData.shengwang.senen;
            document.getElementById("shengwangHuoke").innerText=playerData.shengwang.huoke;
            if(playerData.buff.active){
                document.getElementById("buffStatus").innerText=playerData.buff.name+" | "+playerData.buff.effect;
                document.getElementById("buffTime").innerText=playerData.buff.time+" ç§’";
            }else{
                document.getElementById("buffStatus").innerText="æ— BUFF";
                document.getElementById("buffTime").innerText="0 ç§’";
            }
        }

        // âœ… ä¼˜åŒ–å¯¹è¯æ·»åŠ å‡½æ•°ï¼ˆä¸å˜ï¼‰
        function addDialog(content,isPlayer){
            let dialogBox = document.getElementById("dialogBox");
            let dialogItem = document.createElement("div");
            dialogItem.className = isPlayer ? "dialog-item player-dialog" : "dialog-item npc-dialog";
            // âœ… è¿‡æ»¤undefinedï¼Œç¡®ä¿å†…å®¹ä¸ä¸ºç©º
            dialogItem.innerText = content || "ï¼ˆNPCæ­ªå¤´æ€è€ƒä¸­...ï¼‰";
            dialogBox.appendChild(dialogItem);
            dialogBox.scrollTop = dialogBox.scrollHeight;
        }

        // âœ… BUFFå‡½æ•°ï¼ˆä¸å˜ï¼‰
        function addBuff(buffCfg){
            if(buffTimer) clearInterval(buffTimer);
            playerData.buff = {
                name: buffCfg.name,
                active: true,
                time: buffCfg.duration,
                effect: buffCfg.effect
            };
            updateStatus();
            buffTimer = setInterval(()=>{
                playerData.buff.time--;
                updateStatus();
                if(playerData.buff.time <= 0){
                    clearInterval(buffTimer);
                    playerData.buff.active = false;
                    updateStatus();
                    addDialog(`ã€ç³»ç»Ÿã€‘ä½ çš„ã€Œ${buffCfg.name}ã€BUFFå¤±æ•ˆå•¦ï¼Œå¯ä»¥å†æ‰¾NPCèŠä¸€èŠé‡æ–°è·å¾—å“¦ï½`,false);
                }
            },1000);
        }

        // âœ… ä¼˜åŒ–è®°å¿†å‡½æ•°ï¼šè®°ä½æ›´å¤šç©å®¶æé—®å…³é”®è¯
        function addMemory(keyword){
            if(!playerData.memory.includes(keyword) && keyword.length>1){
                playerData.memory.push(keyword);
                if(playerData.memory.length>playerData.memoryMax){
                    playerData.memory.shift();
                }
            }
        }

        // ===== æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½å¯¹è¯é€»è¾‘ï¼ˆæ¶ˆé™¤undefined+å‘Šåˆ«é‡å¤è¯æœ¯ï¼‰=====
        async function sendMsg() {
            let inputDom = document.getElementById("playerInput");
            let apiKey = document.getElementById("apiKeyInput").value.trim();
            let playerMsg = inputDom.value.trim();
            
            // ç©ºè¾“å…¥åˆ¤æ–­
            if(!playerMsg) {
                addDialog("ã€æç¤ºã€‘è¯·è¾“å…¥ä½ æƒ³å¯¹NPCè¯´çš„è¯ï½", false);
                return;
            }
            // æ— API-KEYåˆ¤æ–­
            if(!apiKey) {
                addDialog("ã€æç¤ºã€‘è¯·å…ˆè¾“å…¥ä½ çš„ç«å±±æ–¹èˆŸAPI-KEYï¼ˆå…è´¹æ³¨å†Œè·å–ï¼‰", false);
                return;
            }

            // æ·»åŠ ç©å®¶å¯¹è¯
            addDialog(playerMsg, true);
            inputDom.value = "";
            addDialog("ã€NPCæ­£åœ¨æ€è€ƒ...ã€‘", false);

            let npc = NPC_CONFIG[currentNPC];
            // âœ… ä¼˜åŒ–Promptï¼šå¼•å¯¼æ¨¡å‹é’ˆå¯¹æ€§å›å¤ï¼Œæ¶ˆé™¤é‡å¤
            let prompt = `
                ä½ ç°åœ¨æ˜¯æ¸¸æˆNPCã€${npc.name}ã€‘ï¼Œæ€§æ ¼${npc.personality}ï¼Œæ“…é•¿${npc.specialty}ã€‚
                ç©å®¶ç°åœ¨é—®ä½ ï¼š${playerMsg}
                è¦æ±‚ï¼š
                1. å®Œå…¨ç¬¦åˆ${npc.name}çš„äººè®¾ï¼Œè¯­æ°”è¦å’Œ${npc.personality}ä¸€è‡´ï¼›
                2. æ ¹æ®ç©å®¶çš„å…·ä½“é—®é¢˜é’ˆå¯¹æ€§å›å¤ï¼Œä¸è¦è¯´æ— å…³çš„è¯ï¼›
                3. å›å¤è¦è‡ªç„¶ã€å£è¯­åŒ–ï¼ŒåƒçœŸå®NPCèŠå¤©ä¸€æ ·ï¼Œä¸è¦å¤ªå®˜æ–¹ï¼›
                4. å¯ä»¥é€‚å½“åŠ å…¥ä¸€ç‚¹ç‚¹å¯çˆ±/ç²—çŠ·/æ²‰ç¨³çš„è¯­æ°”è¯ï¼Œæ¯”å¦‚è‰å¨…ç”¨ã€Œï½ã€ï¼Œæ£®æ©ç”¨ã€Œï¼ã€ï¼Œéœå…‹ç”¨ã€Œã€‚ã€ï¼›
                5. å›å¤é•¿åº¦æ§åˆ¶åœ¨1-3å¥è¯ï¼Œä¸è¦å¤ªé•¿ï¼›
                6. ç©å®¶ä¹‹å‰é—®è¿‡çš„è¯é¢˜ï¼š${playerData.memory.join("ã€")}ï¼Œå¯ä»¥é€‚å½“å‘¼åº”ï¼Œä½†ä¸è¦é‡å¤ã€‚
            `.trim();

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`,
                        "Accept": "*/*",
                        "Accept-Encoding": "gzip, deflate, br",
                        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
                    },
                    body: JSON.stringify({
                        model: "doubao-multimodal-pro", // æˆ–ç”¨doubao-proï¼Œéƒ½å¯ä»¥
                        messages: [{role: "user", content: prompt}],
                        temperature: 0.9, // âœ… æé«˜éšæœºæ€§ï¼Œé¿å…é‡å¤å›å¤
                        max_tokens: 300
                    })
                });

                if(!response.ok) throw new Error(`æ¥å£çŠ¶æ€ç ï¼š${response.status}`);
                const result = await response.json();
                
                // âœ… æ­¥éª¤1ï¼šå®‰å…¨è§£æAIè¿”å›ç»“æœï¼Œæ¶ˆé™¤undefined
                let aiReply = "";
                if(result && result.choices && result.choices[0] && result.choices[0].message && result.choices[0].message.content){
                    aiReply = result.choices[0].message.content.trim();
                }

                // âœ… æ­¥éª¤2ï¼šAIè¿”å›ä¸ºç©ºæ—¶ï¼Œä»NPCçš„å›å¤åº“ä¸­éšæœºé€‰ä¸€ä¸ªï¼Œé¿å…é‡å¤
                if(!aiReply || aiReply.length < 5){
                    const randomIdx = Math.floor(Math.random() * npc.replies.length);
                    aiReply = npc.replies[randomIdx];
                }

                // âœ… æ­¥éª¤3ï¼šè‡ªç„¶æ‹¼æ¥å£å¤´ç¦…ï¼ˆåªåœ¨å›å¤æœ«å°¾åŠ ï¼Œä¸”åªåŠ ä¸€æ¬¡ï¼Œé¿å…å¼ºåˆ¶é‡å¤ï¼‰
                let finalReply = aiReply;
                if(!finalReply.includes(npc.mantra)){
                    // æ ¹æ®NPCæ€§æ ¼è°ƒæ•´å£å¤´ç¦…ä½ç½®
                    if(currentNPC === "liya") finalReply += " " + npc.mantra;
                    if(currentNPC === "senen") finalReply += " " + npc.mantra;
                    if(currentNPC === "huoke") finalReply += " " + npc.mantra;
                }

                // ç§»é™¤åŠ è½½æç¤ºï¼Œæ·»åŠ æœ€ç»ˆå›å¤
                document.getElementById("dialogBox").lastChild.remove();
                addDialog(finalReply, false);

                // âœ… æ­¥éª¤4ï¼šæå–ç©å®¶æé—®å…³é”®è¯ï¼Œæ›´æ–°è®°å¿†ï¼Œè®©åç»­å›å¤æ›´ç²¾å‡†
                const keywords = playerMsg.split(/[ï¼Œã€‚ï¼ï¼Ÿã€\s]/).filter(word => word.length>1);
                keywords.forEach(key => addMemory(key));

                // âœ… è§¦å‘BUFFé€»è¾‘ï¼ˆä¸å˜ï¼‰
                let matchKey = npc.buffKeys.find(key => playerMsg.includes(key));
                if(matchKey){
                    addBuff(npc.buff);
                    playerData.shengwang[currentNPC] += 3;
                    updateStatus();
                }

            } catch (error) {
                // âœ… æŠ¥é”™æ—¶ä¹Ÿç”¨NPCçš„å…œåº•å›å¤ï¼Œé¿å…é‡å¤/undefined
                document.getElementById("dialogBox").lastChild.remove();
                const randomIdx = Math.floor(Math.random() * npc.replies.length);
                const errorReply = npc.replies[randomIdx] + " " + npc.mantra;
                addDialog(`ã€å°æç¤ºã€‘${errorReply}`, false);
                console.log("å¯¹è¯é”™è¯¯ï¼š", error); // æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ï¼Œä¸å½±å“ç©å®¶ä½“éªŒ
            }
        }

        // âœ… é‡‡é›†/æŒ–çŸ¿/æˆ˜æ–—å‡½æ•°ï¼ˆä¼˜åŒ–æç¤ºè¯­ï¼Œæ›´ä¸°å¯Œï¼‰
        function doCollect(){
            let herbNum = 1;
            let expNum = 5;
            let isRare = false;
            if(playerData.buff.active && playerData.buff.name === "é‡‡é›†å¹¸è¿"){
                herbNum = 2;
                expNum = 10;
                if(Math.random() < 0.3){
                    isRare = true;
                    herbNum += 1;
                    expNum += 20;
                    addDialog(`ã€é‡‡é›†ã€‘âœ¨ å“‡ï¼è§¦å‘ç¨€æœ‰è¯è‰ï¼è·å¾—Ã—${herbNum}è¯è‰ï¼Œé¢å¤–ç»éªŒ+20ï¼`,false);
                }
            }
            if(!isRare){
                addDialog(`ã€é‡‡é›†ã€‘ä½ åœ¨æ™¨æ›¦æ£®æ—é‡‡é›†åˆ°äº†Ã—${herbNum}æ ªè–„è·è‰ï¼Œç»éªŒ+${expNum}ï½`,false);
            }
            playerData.herb += herbNum;
            playerData.exp += expNum;
            updateStatus();
        }

        function doMine(){
            let oreNum = 1;
            let expNum = 5;
            if(playerData.buff.active && playerData.buff.name === "æŒ–çŸ¿æš´å‡»"){
                oreNum = 2;
                expNum = 10;
                addDialog(`ã€æŒ–çŸ¿ã€‘ğŸ’¥ æŒ–çŸ¿æš´å‡»ï¼æŒ–åˆ°äº†Ã—${oreNum}å—é“çŸ¿ï¼Œç»éªŒ+${expNum}ï¼`,false);
            }else{
                addDialog(`ã€æŒ–çŸ¿ã€‘ä½ åœ¨é»‘çŸ³å±±çŸ¿æ´æŒ–åˆ°äº†Ã—${oreNum}å—é“œçŸ¿ï¼Œç»éªŒ+${expNum}ï½`,false);
            }
            playerData.ore += oreNum;
            playerData.exp += expNum;
            updateStatus();
        }

        function doFight(){
            let expNum = 10;
            const monsters = ["å“¥å¸ƒæ—","å²è±å§†","å…½äººå°å…µ","é‡çŒª"];
            const randomMonster = monsters[Math.floor(Math.random() * monsters.length)];
            if(playerData.buff.active && playerData.buff.name === "å¼±ç‚¹ç¿»å€"){
                expNum = 20;
                addDialog(`ã€æˆ˜æ–—ã€‘âš”ï¸ ç²¾å‡†å‘½ä¸­${randomMonster}çš„å¼±ç‚¹ï¼æ‰“èµ¢äº†å®ƒï¼Œç»éªŒ+${expNum}ï¼`,false);
            }else{
                addDialog(`ã€æˆ˜æ–—ã€‘ä½ å‡»è´¥äº†${randomMonster}ï¼Œè·å¾—ç»éªŒ+${expNum}ï½`,false);
            }
            playerData.exp += expNum;
            updateStatus();
        }

        // âœ… ä¼˜åŒ–NPCåˆ‡æ¢é€»è¾‘ï¼šåˆ‡æ¢æ—¶æç¤ºæ›´ä¸°å¯Œ
        function changeNPC(npcKey){
            currentNPC = npcKey;
            const npc = NPC_CONFIG[npcKey];
            document.getElementById("npcInfo").innerHTML = 
                `<b>å½“å‰NPCï¼š</b>${npc.name}<br>
                <b>æ€§æ ¼ï¼š</b>${npc.personality} | <b>æ“…é•¿ï¼š</b>${npc.specialty} | <b>å£å¤´ç¦…ï¼š</b>${npc.mantra}`;
            // åˆ‡æ¢NPCçš„æ¬¢è¿è¯­æ›´ä¸ªæ€§åŒ–
            const welcomeWords = {
                liya: `ä½ åˆ‡æ¢åˆ°äº†ã€${npc.name}ã€‘ï¼Œæˆ‘è¶…æ‡‚è¯è‰çš„ï¼Œæœ‰ä»€ä¹ˆæƒ³é—®çš„éƒ½å¯ä»¥è¯´å“¦ï½`,
                senen: `ä½ åˆ‡æ¢åˆ°äº†ã€${npc.name}ã€‘ï¼ŒæŒ–çŸ¿é”»é€ æˆ‘æœ€åœ¨è¡Œï¼Œå°½ç®¡é—®ï¼`,
                huoke: `ä½ åˆ‡æ¢åˆ°äº†ã€${npc.name}ã€‘ï¼Œæˆ˜æ–—çš„äº‹ï¼Œé—®æˆ‘å°±å¯¹äº†ã€‚`
            };
            addDialog(welcomeWords[npcKey] || `ä½ åˆ‡æ¢åˆ°äº†ã€${npc.name}ã€‘ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜éƒ½å¯ä»¥é—®æˆ‘å“¦ï½`,false);
            // æ¸…ç©ºè®°å¿†ï¼Œé¿å…å’Œä¸Šä¸€ä¸ªNPCçš„è¯é¢˜æ··æ·†
            playerData.memory = [];
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload=function(){
            updateStatus();
            document.getElementById("playerInput").onkeydown=e=>{
                if(e.keyCode === 13) sendMsg();
            };
        };
    </script>
</body>
</html>