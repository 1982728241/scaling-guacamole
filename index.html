<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YPYå†’é™©æ¸¸æˆ - AI NPCçµæ±å¯¹è¯ï¼ˆæœ€ç»ˆå®Œç¾ç‰ˆï¼‰</title>
    <style>
        body {
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            background-color: #1a1a2e;
            color: #fff;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .npc-info {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #4cc9f0;
            padding-bottom: 10px;
        }
        .npc-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #4cc9f0;
        }
        .npc-name {
            font-size: 24px;
            margin: 10px 0;
            color: #4cc9f0;
        }
        .npc-desc {
            font-size: 14px;
            color: #a0a0a0;
        }
        .dialog-container {
            height: 400px;
            border: 2px solid #4cc9f0;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            background-color: #2a2a40;
            margin-bottom: 20px;
        }
        .dialog-message {
            margin: 10px 0;
            max-width: 70%;
            line-height: 1.5;
        }
        .player-msg {
            margin-left: auto;
            background-color: #4cc9f0;
            color: #1a1a2e;
            padding: 8px 15px;
            border-radius: 15px 15px 0 15px;
        }
        .npc-msg {
            background-color: #4361ee;
            padding: 8px 15px;
            border-radius: 15px 15px 15px 0;
        }
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        #player-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #4cc9f0;
            border-radius: 25px;
            background-color: #2a2a40;
            color: #fff;
            outline: none;
        }
        #send-btn {
            padding: 12px 25px;
            background-color: #4cc9f0;
            color: #1a1a2e;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }
        #send-btn:hover {
            background-color: #3aabd0;
        }
        .api-config {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #222238;
            border-radius: 10px;
            border: 1px solid #4cc9f0;
        }
        #api-key-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #4cc9f0;
            border-radius: 20px;
            background-color: #2a2a40;
            color: #fff;
            outline: none;
        }
        #save-key-btn {
            padding: 10px 20px;
            background-color: #4cc9f0;
            color: #1a1a2e;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        #save-key-btn:hover {
            background-color: #3aabd0;
        }
        .tip-text {
            color: #4cc9f0;
            font-size: 12px;
            text-align: center;
            margin: 5px 0;
            height: 14px;
        }
        .mode-switch {
            text-align: center;
            margin-top: 5px;
        }
        #mode-btn {
            padding: 8px 20px;
            border-radius: 20px;
            border: 2px solid #4cc9f0;
            background-color: #2a2a40;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
        }
        #mode-btn.ai-mode {
            background-color: #4cc9f0;
            color: #1a1a2e;
        }
        #mode-btn.local-mode {
            background-color: #2a2a40;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="npc-info">
        <img src="https://picsum.photos/80" alt="NPCå¤´åƒ" class="npc-avatar">
        <h2 class="npc-name">çµæ±</h2>
        <p class="npc-desc">å¼‚ä¸–ç•Œçš„å‘å¯¼ç²¾çµï¼Œç†Ÿæ‚‰æ£®æ—ä¸é—è¿¹çš„ç§˜å¯†ï¼Œæ€§æ ¼æ¸©å’Œä½†è­¦æƒ•é™Œç”Ÿäºº</p>
    </div>

    <div class="dialog-container" id="dialog-history">
        <div class="dialog-message npc-msg">ä½ å¥½å‘€ï¼Œæ—…è¡Œè€…ï¼æˆ‘æ˜¯çµæ±ï¼Œéœ€è¦æˆ‘å¸®ä½ æŒ‡å¼•æ–¹å‘å—ï¼Ÿ</div>
    </div>

    <div class="input-area">
        <input type="text" id="player-input" placeholder="è¾“å…¥ä½ æƒ³å¯¹çµæ±è¯´çš„è¯..." autofocus>
        <button id="send-btn">å‘é€</button>
    </div>

    <div class="api-config">
        <input type="password" id="api-key-input" placeholder="è¯·è¾“å…¥ä½ çš„ç«å±±æ–¹èˆŸAPIå¯†é’¥ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰">
        <button id="save-key-btn">ä¿å­˜å¯†é’¥</button>
    </div>
    <div class="tip-text" id="tip-text"></div>

    <div class="mode-switch">
        <button id="mode-btn" class="local-mode">ğŸ”´ å½“å‰æ¨¡å¼ï¼šæœ¬åœ°æµ‹è¯•ï¼ˆä»…å…³é”®è¯å›å¤ï¼‰</button>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½®é¡¹ ==========
        const NPC_CONFIG = {
            name: "çµæ±",
            replyMap: {
                "ä½ å¥½": "æ—…è¡Œè€…ä½ å¥½å‘€~ ç¬¬ä¸€æ¬¡æ¥è¿™ç‰‡æ£®æ—å—ï¼Ÿ",
                "ä»»åŠ¡": "å¬è¯´ä¸œè¾¹çš„é—è¿¹é‡Œè—ç€å¤è€çš„å®è—ï¼Œä¸è¿‡é‚£é‡Œæœ‰é­”ç‰©çœ‹å®ˆå“¦ï¼",
                "YPY": "ä½ æ˜¯è¯´YPYå—ï¼Ÿæˆ‘å¥½åƒåœ¨æ£®æ—æ·±å¤„è§è¿‡Taï¼ŒTaå½“æ—¶åœ¨å’Œä¸€åªå·¨ç‹¼å¯¹è¯å‘¢ï¼",
                "å†è§": "ä¸€è·¯é¡ºé£å‘€ï¼Œæ—…è¡Œè€…ï¼å¦‚æœé‡åˆ°å±é™©ï¼Œè®°å¾—å‘¼å”¤æˆ‘çš„åå­—~",
                "å®è—": "å®è—ï¼Ÿé‚£å¯æ˜¯éœ€è¦å‹‡æ°”å’Œæ™ºæ…§æ‰èƒ½æ‹¿åˆ°çš„ï¼Œä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ"
            },
            defaultReply: "å—¯... æˆ‘ä¸å¤ªæ˜ç™½ä½ çš„æ„æ€å‘¢ï¼Œå¯ä»¥æ¢ä¸ªè¯´æ³•å—ï¼Ÿ"
        };

        const AI_API_CONFIG = {
            apiKey: "",
            apiUrl: "https://ark.cn-beijing.volces.com/api/v3/responses",
            model: "doubao-seed-1-8-251228",
            prompt: `ä½ æ˜¯å¼‚ä¸–ç•Œå†’é™©æ¸¸æˆä¸­çš„ç²¾çµNPCçµæ±ï¼Œæ€§æ ¼æ¸©å’Œã€ç†Ÿæ‚‰æ£®æ—çŸ¥è¯†ï¼Œè¯´è¯è¯­æ°”å¯çˆ±ï¼Œä¼šä¸»åŠ¨ç»™æ—…è¡Œè€…æä¾›å†’é™©å»ºè®®ï¼Œä¸è¦è¯´ç°ä»£ç½‘ç»œç”¨è¯­ï¼Œå›å¤æ§åˆ¶åœ¨80å­—ä»¥å†…ï¼Œè¯­æ°”äº²åˆ‡è‡ªç„¶ã€‚`
        };

        // ========== å…¨å±€çŠ¶æ€ ==========
        let isLocalMode = true;
        const dialogHistory = document.getElementById("dialog-history");
        const playerInput = document.getElementById("player-input");
        const sendBtn = document.getElementById("send-btn");
        const modeBtn = document.getElementById("mode-btn");
        const apiKeyInput = document.getElementById("api-key-input");
        const saveKeyBtn = document.getElementById("save-key-btn");
        const tipText = document.getElementById("tip-text");

        // ========== é¡µé¢åŠ è½½è‡ªåŠ¨è¯»å–å¯†é’¥ ==========
        window.onload = function(){
            const savedKey = localStorage.getItem("ai_npc_api_key");
            if(savedKey){
                apiKeyInput.value = savedKey;
                AI_API_CONFIG.apiKey = savedKey;
                tipText.innerText = "âœ… å·²åŠ è½½æœ¬åœ°ä¿å­˜çš„å¯†é’¥ï¼Œå¯ç›´æ¥ä½¿ç”¨AIæ¨¡å¼";
                console.log("ã€åˆå§‹åŒ–ã€‘å·²åŠ è½½æœ¬åœ°ç¼“å­˜çš„APIå¯†é’¥");
            }
        };

        // ========== å·¥å…·å‡½æ•° ==========
        function addMessage(content, isPlayer) {
            const msgDiv = document.createElement("div");
            msgDiv.className = isPlayer 
                ? "dialog-message player-msg" 
                : "dialog-message npc-msg";
            msgDiv.textContent = content;
            dialogHistory.appendChild(msgDiv);
            dialogHistory.scrollTop = dialogHistory.scrollHeight;
        }

        function getLocalReply(userInput) {
            const input = userInput.toLowerCase().trim();
            for (const [keyword, reply] of Object.entries(NPC_CONFIG.replyMap)) {
                if (input.includes(keyword.toLowerCase())) {
                    return reply;
                }
            }
            return NPC_CONFIG.defaultReply;
        }

        /**
         * æ ¸å¿ƒä¿®å¤ï¼š100%é€‚é…ä½ çš„ç«å±±æ–¹èˆŸè¿”å›æ ¼å¼ï¼ˆoutput[1].content[0].textï¼‰
         */
        async function getAIReply(userInput) {
            if(!AI_API_CONFIG.apiKey || AI_API_CONFIG.apiKey.trim() === ""){
                console.error("ã€AIè¯·æ±‚ã€‘å¤±è´¥ï¼šAPIå¯†é’¥ä¸ºç©º");
                return "âš ï¸ è¯·å…ˆè¾“å…¥å¹¶ä¿å­˜ä½ çš„ç«å±±æ–¹èˆŸAPIå¯†é’¥ï¼";
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            try {
                console.log("ã€AIè¯·æ±‚ã€‘å¼€å§‹è°ƒç”¨ç«å±±æ–¹èˆŸAPIï¼Œç©å®¶è¾“å…¥ï¼š", userInput);
                const response = await fetch(AI_API_CONFIG.apiUrl, {
                    method: "POST",
                    mode: 'cors',
                    cache: 'no-cache',
                    credentials: 'omit',
                    keepalive: true,
                    signal: controller.signal,
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${AI_API_CONFIG.apiKey.trim()}`
                    },
                    body: JSON.stringify({
                        "model": AI_API_CONFIG.model,
                        "input": [
                            {
                                "role": "user",
                                "content": [
                                    {
                                        "type": "input_text",
                                        "text": `${AI_API_CONFIG.prompt}\nç©å®¶ï¼š${userInput}\nçµæ±ï¼š`
                                    }
                                ]
                            }
                        ]
                    })
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errText = await response.text();
                    console.error(`ã€AIè¯·æ±‚ã€‘HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š${response.status}ï¼Œå“åº”ï¼š${errText}`);
                    if(response.status === 401) return "âŒ å¯†é’¥æ— æ•ˆ/è¿‡æœŸï¼Œè¯·é‡æ–°è¾“å…¥ï¼";
                    if(response.status === 403) return "âŒ æ— æƒé™è°ƒç”¨è¯¥æ¨¡å‹ï¼Œè¯·æ£€æŸ¥å¯†é’¥æƒé™ï¼";
                    if(response.status === 404) return "âŒ æ¥å£åœ°å€é”™è¯¯ï¼Œè¯·æ ¸å¯¹API URLï¼";
                    if(response.status === 500) return "âŒ æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ï¼";
                    return `âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ã€çŠ¶æ€ç :${response.status}ã€‘`;
                }

                const data = await response.json();
                console.log("ã€AIè¯·æ±‚ã€‘ç«å±±æ–¹èˆŸè¿”å›çš„å®Œæ•´æ•°æ®ï¼š", JSON.stringify(data, null, 2));

                // ========== 100%é€‚é…ä½ çš„è¿”å›æ ¼å¼ï¼šoutput[1].content[0].text ==========
                let aiReply = "";
                if (data?.output?.[1]?.content?.[0]?.text) {
                    aiReply = data.output[1].content[0].text;
                    console.log("ã€AIè¯·æ±‚ã€‘æˆåŠŸè§£æåˆ°å›å¤ï¼š", aiReply);
                } 
                // å…¶ä»–æ ¼å¼å…œåº•
                else if (data?.data?.result) aiReply = data.data.result;
                else if (data?.output?.choices?.[0]?.content?.text) aiReply = data.output.choices[0].content.text;
                else if (data?.choices?.[0]?.message?.content) aiReply = data.choices[0].message.content;
                else if (data?.text) aiReply = data.text;

                aiReply = aiReply.trim();
                return aiReply || NPC_CONFIG.defaultReply;

            } catch (error) {
                clearTimeout(timeoutId);
                console.error("ã€AIè¯·æ±‚ã€‘å¼‚å¸¸é”™è¯¯ï¼š", error);
                if (error.name === 'AbortError') return "âŒ è¯·æ±‚è¶…æ—¶ï¼šæœåŠ¡å™¨å“åº”è¿‡æ…¢ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼";
                if (error.name === 'TypeError') return "âŒ è·¨åŸŸæœªè§£å†³/ç½‘ç»œæ–­å¼€ï¼Œè¯·ç”¨Live Serveræ‰“å¼€ï¼";
                return "âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œå¯†é’¥é…ç½®ï¼";
            }
        }

        // ========== ä¿å­˜APIå¯†é’¥ ==========
        function saveApiKey(){
            const key = apiKeyInput.value.trim();
            console.log("ã€å¯†é’¥ä¿å­˜ã€‘å°è¯•ä¿å­˜å¯†é’¥ï¼ˆå4ä½ï¼‰ï¼š", key.slice(-4));
            
            if(key === ""){
                tipText.innerText = "âŒ å¯†é’¥ä¸èƒ½ä¸ºç©ºï¼Œè¯·è¾“å…¥åå†ä¿å­˜ï¼";
                console.error("ã€å¯†é’¥ä¿å­˜ã€‘å¤±è´¥ï¼šå¯†é’¥ä¸ºç©º");
                return;
            }
            
            AI_API_CONFIG.apiKey = key;
            localStorage.setItem("ai_npc_api_key", key);
            tipText.innerText = "âœ… å¯†é’¥ä¿å­˜æˆåŠŸï¼å¯åˆ‡æ¢AIæ¨¡å¼ä½¿ç”¨";
            console.log("ã€å¯†é’¥ä¿å­˜ã€‘æˆåŠŸï¼Œå·²å­˜å…¥æœ¬åœ°ç¼“å­˜");
            
            setTimeout(()=>{tipText.innerText = ""},3000);
        }

        // ========== å‘é€æ¶ˆæ¯ ==========
        async function sendMessage() {
            const inputContent = playerInput.value.trim();
            if (!inputContent) return;

            addMessage(inputContent, true);
            playerInput.value = "";

            if (isLocalMode) {
                const input = inputContent.toLowerCase().trim();
                const hasKeyword = Object.keys(NPC_CONFIG.replyMap).some(keyword => 
                    input.includes(keyword.toLowerCase())
                );
                if (!hasKeyword) {
                    addMessage("ğŸ’¡ æç¤ºï¼šå½“å‰æ˜¯æœ¬åœ°æ¨¡å¼ï¼Œä»…æ”¯æŒã€Œä½ å¥½/ä»»åŠ¡/YPY/å†è§/å®è—ã€å…³é”®è¯å›å¤ï¼ç‚¹å‡»åº•éƒ¨æŒ‰é’®åˆ‡æ¢AIæ¨¡å¼å¯è‡ªç”±èŠå¤©~", false);
                    return;
                }
            }

            addMessage("çµæ±æ­£åœ¨æ€è€ƒä¸­...", false);

            let reply = "";
            if (isLocalMode) {
                reply = getLocalReply(inputContent);
            } else {
                reply = await getAIReply(inputContent);
            }

            setTimeout(() => {
                dialogHistory.removeChild(dialogHistory.lastChild);
                addMessage(reply, false);
            }, 500);
        }

        // ========== äº‹ä»¶ç›‘å¬ ==========
        sendBtn.addEventListener("click", sendMessage);
        playerInput.addEventListener("keydown", (e) => e.key === "Enter" && sendMessage());

        modeBtn.addEventListener("click", () => {
            isLocalMode = !isLocalMode;
            console.log("ã€æ¨¡å¼åˆ‡æ¢ã€‘æˆåŠŸï¼Œå½“å‰æ˜¯å¦ä¸ºæœ¬åœ°æ¨¡å¼ï¼š", isLocalMode);
            
            if (isLocalMode) {
                modeBtn.textContent = "ğŸ”´ å½“å‰æ¨¡å¼ï¼šæœ¬åœ°æµ‹è¯•ï¼ˆä»…å…³é”®è¯å›å¤ï¼‰";
                modeBtn.className = "local-mode";
                tipText.innerText = "âš ï¸ æœ¬åœ°æ¨¡å¼ä»…æ”¯æŒã€Œä½ å¥½/ä»»åŠ¡/YPY/å†è§/å®è—ã€å…³é”®è¯å›å¤";
            } else {
                modeBtn.textContent = "ğŸŸ¢ å½“å‰æ¨¡å¼ï¼šç«å±±æ–¹èˆŸAIè”ç½‘å¯¹è¯ï¼ˆè‡ªç”±èŠå¤©ï¼‰";
                modeBtn.className = "ai-mode";
                tipText.innerText = "âœ… AIæ¨¡å¼å·²æ¿€æ´»ï¼è¯·ç¡®ä¿å·²ä¿å­˜å¯†é’¥ï¼Œå¯è‡ªç”±èŠå¤©~";
            }
            
            setTimeout(()=>{tipText.innerText = ""}, 5000);
        });

        saveKeyBtn.addEventListener("click", saveApiKey);
        apiKeyInput.addEventListener("keydown", (e) => e.key === "Enter" && saveApiKey());
    </script>
</body>
</html>